#!/usr/bin/env bash

# Add git-tree to PATH
# --------------------
if [[ ! "\$PATH" == *$INSTALL_PATH* ]]; then
    PATH="\${PATH:+\${PATH}:}$INSTALL_PATH"
fi

# Install bash-preexec
# --------------------
lno="$(\grep -nF "source ~/.bash-preexec.sh" ~/.bashrc | sed 's/:.*//' | tr '\n' ' ')"
if [ -z "$lno" ]; then
    curl https://raw.githubusercontent.com/rcaloras/bash-preexec/master/bash-preexec.sh -so ~/.bash-preexec.sh
    source ~/.bash-preexec.sh
fi

_gittree_git_command=false

git_intercept_preexec() {
    command=($1)
    if [ "${command[0]}" != "git" ]; then
        _gittree_git_command=false && return
    fi

    _gittree_git_command=true
    case ${command[1]} in
    commit)
        # TODO: Execute git-tree code...
        echo committing...
        ;;
    rebase)
        # TODO: Execute git-tree code...
        echo rebasing...
        ;;
    *)
        ;;
    esac
}

git_intercept_precmd() {
    [ ${_gittree_git_command} = false ] && return

    # Print exit status
    local status="$?"
    echo ${status}

    # TODO: Execute git-tree code... (e.g. commit changes from `preexec` if the
    # git command was successful)
}

preexec_functions+=(git_intercept_preexec)
precmd_functions+=(git_intercept_precmd)
